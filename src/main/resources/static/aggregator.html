<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f4f4f4;
        }
        header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .container {
            width: 90%;
            max-width: 1100px;
            margin: 1rem auto;
            background: white;
            padding: 1.5rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ */
        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .search-bar input[type="text"] {
            flex: 1;
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .search-bar button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: none;
            background: #3498db;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        .search-bar button:hover {
            background: #2980b9;
        }
        /* –§–∏–ª—å—Ç—Ä—ã (–≥–æ—Ä–æ–¥, –∫–æ–º–ø–∞–Ω–∏—è, –∑–∞—Ä–ø–ª–∞—Ç–∞) */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .filters > div {
            flex: 1 1 200px;
        }
        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        input[type="text"], select {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        /* –¢–∞–±–ª–∏—Ü–∞ –≤–∞–∫–∞–Ω—Å–∏–π */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background: #ecf0f1;
            cursor: pointer;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        .loading {
            text-align: center;
            margin: 2rem 0;
            font-size: 1.1rem;
            color: #555;
        }
        /* –≠–∫—Å–ø–æ—Ä—Ç –∏ –∫–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .export-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        .export-buttons button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: none;
            background: #27ae60;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        .export-buttons button:hover {
            background: #1e8449;
        }
        /* –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .create-notification {
            margin-top: 2rem;
            text-align: center;
        }
        .create-notification button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border: none;
            background: #e67e22;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        .create-notification button:hover {
            background: #d35400;
        }
        @media (max-width: 600px) {
            .search-bar, .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>–í–∞–∫–∞–Ω—Å–∏–∏</h1>
    <a href="/analytics.html" style="color:#ecf0f1; margin-left:1rem;">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
</header>

<div class="container">

    <!-- 1. –ï–¥–∏–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é -->
    <div class="search-bar">
        <input type="text" id="searchKeyword" placeholder="–ü–æ–∏—Å–∫..." />
        <button id="btn-search">–ù–∞–π—Ç–∏</button>
        <button id="btn-reset">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <!-- 2. –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–≥–æ—Ä–æ–¥, –∫–æ–º–ø–∞–Ω–∏—è, –º–∏–Ω. –∑–∞—Ä–ø–ª–∞—Ç–∞) -->
    <div class="filters">
        <div>
            <label for="filter-city">–ì–æ—Ä–æ–¥</label>
            <input type="text" id="filter-city" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥" />
        </div>
        <div>
            <label for="filter-company">–ö–æ–º–ø–∞–Ω–∏—è</label>
            <input type="text" id="filter-company" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é" />
        </div>
        <div>
            <label for="filter-salary">–ú–∏–Ω. –∑–∞—Ä–ø–ª–∞—Ç–∞</label>
            <input type="text" id="filter-salary" placeholder="–û—Ç (—á–∏—Å–ª–æ)" />
        </div>
        <div>
            <label for="sort-by">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="sort-by">
                <option value="publicationDate,desc">–ü–æ –¥–∞—Ç–µ (—Å–≤–µ–∂–∏–µ)</option>
                <option value="publicationDate,asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ)</option>
                <option value="salary,desc">–ü–æ –∑–∞—Ä–ø–ª–∞—Ç–µ (—É–±—ã–≤.)</option>
                <option value="salary,asc">–ü–æ –∑–∞—Ä–ø–ª–∞—Ç–µ (–≤–æ–∑—Ä.)</option>
            </select>
        </div>
        <div style="align-self: flex-end;">
            <button id="btn-filter">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- 3. –¢–∞–±–ª–∏—Ü–∞ –≤–∞–∫–∞–Ω—Å–∏–π -->
    <div id="vacancies-container">
        <div class="loading" id="loading-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <table id="vacancies-table" style="display: none;">
            <thead>
            <tr>
                <th data-field="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                <th data-field="company">–ö–æ–º–ø–∞–Ω–∏—è</th>
                <th data-field="salary">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
                <th data-field="city">–ì–æ—Ä–æ–¥</th>
                <th data-field="publicationDate">–î–∞—Ç–∞</th>
            </tr>
            </thead>
            <tbody id="vacancies-body">
            <!-- —Å—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å—Ç—Ä–æ–∫–∏ -->
            </tbody>
        </table>
    </div>

    <!-- 4. –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <div class="export-buttons">
        <button id="export-csv">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
        <button id="export-json">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
        <button id="export-html">–≠–∫—Å–ø–æ—Ä—Ç –≤ HTML</button>
    </div>

    <!-- 5. –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="create-notification">
        <button id="btn-create-notification">–°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
    </div>

</div>

<script>
    // –ë–∞–∑–æ–≤—ã–π URL –±–µ–∫–µ–Ω–¥–∞
    const API_URL = '/api/vacancies';

    // –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞/–ø–æ–∏—Å–∫–∞/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    let params = {
        page: 0,
        size: 50,
        sort: 'publicationDate,desc'
    };

    // HTML-—ç–ª–µ–º–µ–Ω—Ç—ã
    const loadingIndicator = document.getElementById('loading-indicator');
    const vacanciesTable   = document.getElementById('vacancies-table');
    const vacanciesBody    = document.getElementById('vacancies-body');
    const searchInput      = document.getElementById('searchKeyword');
    const cityInput        = document.getElementById('filter-city');
    const companyInput     = document.getElementById('filter-company');
    const salaryInput      = document.getElementById('filter-salary');
    const sortSelect       = document.getElementById('sort-by');
    const btnCreateNotif   = document.getElementById('btn-create-notification');

    // –°–±–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –æ–±—ä–µ–∫—Ç params
    function gatherParams() {
        const kw      = searchInput.value.trim();
        const city    = cityInput.value.trim();
        const company = companyInput.value.trim();
        const salary  = salaryInput.value.trim();
        const sortBy  = sortSelect.value;

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        params.sort = sortBy;
        // –ü—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–∏—Å–∫–µ/—Ñ–∏–ª—å—Ç—Ä–µ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        params.page = 0;

        if (kw)      params.keyword = kw;
        else         delete params.keyword;

        if (city)    params.city = city;
        else         delete params.city;

        if (company) params.company = company;
        else         delete params.company;

        if (salary)  params.salary = salary;
        else         delete params.salary;
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ query-string –∏–∑ params
    function buildQuery(obj) {
        return Object.keys(obj)
            .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(obj[key]))
            .join('&');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π —Å –±–µ–∫–µ–Ω–¥–∞
    async function loadVacancies() {
        loadingIndicator.style.display = 'block';
        vacanciesTable.style.display = 'none';
        vacanciesBody.innerHTML = '';

        gatherParams();
        const qs  = buildQuery(params);
        const url = API_URL + (qs ? ('?' + qs) : '');

        try {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ ' + resp.status);
            const data = await resp.json();

            let list = [];
            if (Array.isArray(data)) {
                list = data;
            } else if (data.content && Array.isArray(data.content)) {
                list = data.content;
            }

            renderVacancies(list);
        } catch (err) {
            console.error(err);
            vacanciesBody.innerHTML = '<tr><td colspan="5">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏.</td></tr>';
            vacanciesTable.style.display = 'table';
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π
    function renderVacancies(list) {
        vacanciesBody.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
            vacanciesBody.innerHTML = '<tr><td colspan="5">–í–∞–∫–∞–Ω—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td></tr>';
        } else {
            list.forEach(v => {
                const tr = document.createElement('tr');

                // 1) –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Å—Å—ã–ª–∫–∞)
                const tdTitle = document.createElement('td');
                const a        = document.createElement('a');
                a.href        = v.url || '#';
                a.target      = '_blank';
                a.textContent = v.title || '‚Äî';
                tdTitle.appendChild(a);
                tr.appendChild(tdTitle);

                // 2) –ö–æ–º–ø–∞–Ω–∏—è
                const tdComp = document.createElement('td');
                tdComp.textContent = v.company || '‚Äî';
                tr.appendChild(tdComp);

                // 3) –ó–∞—Ä–ø–ª–∞—Ç–∞
                const tdSal = document.createElement('td');
                tdSal.textContent = (v.salary != null && v.salary !== '') ? v.salary : '‚Äî';
                tr.appendChild(tdSal);

                // 4) –ì–æ—Ä–æ–¥
                const tdCity = document.createElement('td');
                tdCity.textContent = v.city || '‚Äî';
                tr.appendChild(tdCity);

                // 5) –î–∞—Ç–∞ (–¥–¥.–º–º.–≥–≥–≥–≥)
                const tdDate = document.createElement('td');
                if (v.publicationDate) {
                    const d   = new Date(v.publicationDate);
                    const dd  = String(d.getDate()).padStart(2, '0');
                    const mm  = String(d.getMonth() + 1).padStart(2, '0');
                    const yyyy = d.getFullYear();
                    tdDate.textContent = `${dd}.${mm}.${yyyy}`;
                } else {
                    tdDate.textContent = '‚Äî';
                }
                tr.appendChild(tdDate);

                vacanciesBody.appendChild(tr);
            });
        }
        vacanciesTable.style.display = 'table';
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    function exportToCSV() {
        gatherParams();
        const qs = buildQuery({ ...params, size: 10000 });
        fetch(API_URL + '?' + qs)
            .then(r => r.json())
            .then(data => {
                let list = [];
                if (Array.isArray(data)) list = data;
                else if (data.content && Array.isArray(data.content)) list = data.content;

                const headers = ['–ó–∞–≥–æ–ª–æ–≤–æ–∫','–ö–æ–º–ø–∞–Ω–∏—è','–ó–∞—Ä–ø–ª–∞—Ç–∞','–ì–æ—Ä–æ–¥','–î–∞—Ç–∞'];
                const rows = list.map(v => {
                    const date = v.publicationDate
                        ? new Date(v.publicationDate).toISOString().split('T')[0]
                        : '';
                    return [
                        `"${(v.title || '').replace(/"/g,'""')}"`,
                        `"${(v.company || '').replace(/"/g,'""')}"`,
                        v.salary != null ? `"${v.salary}"` : '',
                        `"${(v.city || '').replace(/"/g,'""')}"`,
                        date ? `"${date}"` : ''
                    ].join(';');
                });
                const csv = [headers.join(';'), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a   = document.createElement('a');
                a.href    = url;
                a.download= 'vacancies.csv';
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => console.error(err));
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
    function exportToJSON() {
        gatherParams();
        const qs = buildQuery({ ...params, size: 10000 });
        fetch(API_URL + '?' + qs)
            .then(r => r.json())
            .then(data => {
                let list = [];
                if (Array.isArray(data)) list = data;
                else if (data.content && Array.isArray(data.content)) list = data.content;

                const blob = new Blob([JSON.stringify(list, null, 2)], { type: 'application/json' });
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href     = url;
                a.download = 'vacancies.json';
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => console.error(err));
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ HTML
    function exportToHTML() {
        gatherParams();
        const qs = buildQuery({ ...params, size: 10000 });
        fetch(API_URL + '?' + qs)
            .then(r => r.json())
            .then(data => {
                let list = [];
                if (Array.isArray(data)) list = data;
                else if (data.content && Array.isArray(data.content)) list = data.content;

                let html = `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–≠–∫—Å–ø–æ—Ä—Ç –≤–∞–∫–∞–Ω—Å–∏–π</title>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>–≠–∫—Å–ø–æ—Ä—Ç –≤–∞–∫–∞–Ω—Å–∏–π</h1>
  <table>
    <thead>
      <tr>
        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
        <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
        <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
        <th>–ì–æ—Ä–æ–¥</th>
        <th>–î–∞—Ç–∞</th>
      </tr>
    </thead>
    <tbody>
`;
                list.forEach(v => {
                    const date = v.publicationDate
                        ? new Date(v.publicationDate).toISOString().split('T')[0]
                        : '';
                    html += `
      <tr>
        <td><a href="${v.url || '#'}" target="_blank">${v.title || ''}</a></td>
        <td>${v.company || ''}</td>
        <td>${v.salary != null ? v.salary : ''}</td>
        <td>${v.city || ''}</td>
        <td>${date}</td>
      </tr>
`;
                });
                html += `
    </tbody>
  </table>
</body>
</html>
`;
                const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href     = url;
                a.download = 'vacancies.html';
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => console.error(err));
    }

    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('btn-search').addEventListener('click', loadVacancies);
    document.getElementById('btn-reset').addEventListener('click', () => {
        searchInput.value  = '';
        cityInput.value    = '';
        companyInput.value = '';
        salaryInput.value  = '';
        sortSelect.value   = 'publicationDate,desc';
        loadVacancies();
    });
    document.getElementById('btn-filter').addEventListener('click', loadVacancies);
    document.getElementById('export-csv').addEventListener('click', exportToCSV);
    document.getElementById('export-json').addEventListener('click', exportToJSON);
    document.getElementById('export-html').addEventListener('click', exportToHTML);

    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    btnCreateNotif.addEventListener('click', () => {
        window.location.href = '/notification.html';
    });

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏–∏
    window.addEventListener('DOMContentLoaded', loadVacancies);
</script>

</body>
</html>